{
  "hash": "aba407407a925c528d1e5f94f5c64107",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"image processing\"\nsubtitle: \"with magick\"\n\nauthor: \"Tony Duan\"\n\nexecute:\n  warning: false\n  error: false\n\nformat:\n  html:\n    toc: true\n    toc-location: right\n    code-fold: show\n    code-tools: true\n    number-sections: false\n    code-block-bg: true\n    code-block-border-left: \"#31BAE9\"\n    code-copy: true\n---\n\nThis document provides a practical guide to image processing in R using the `magick` package. The `magick` package is a powerful and versatile tool for image manipulation, providing a wide range of functions for reading, writing, editing, and transforming images. It is built on top of the ImageMagick library, a robust and feature-rich image processing software.\n\nWe will cover the basics of reading and writing images, as well as more advanced topics like color manipulation, transformations, and adding text and borders. We will also explore how to integrate `magick` with `ggplot2` to create more visually appealing and informative plots.\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load the magick library\nlibrary(magick)\n```\n:::\n\n# 1. Reading and Writing Images\n\nThe first step in any image processing workflow is to read an image into R. The `image_read()` function can read images from a local file or a URL.\n\n## Reading an Image\n\n::: {.cell}\n\n```{.r .cell-code}\n# Read an image from a local file\nraw_logo <- image_read('./images/comb.webp')\n```\n:::\n\n## Getting Image Information\n\nThe `image_info()` function provides useful information about an image, such as its format, width, height, and colorspace.\n\n::: {.cell}\n\n```{.r .cell-code}\nimage_info(raw_logo)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  format width height colorspace matte filesize density\n1   WEBP   450    303       sRGB  TRUE    49650   72x72\n```\n\n\n:::\n:::\n\n## Changing Image Format\n\nThe `image_convert()` function allows you to convert an image from one format to another.\n\n::: {.cell}\n\n```{.r .cell-code}\nnew_png <- image_convert(raw_logo, \"png\")\nimage_info(new_png)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  format width height colorspace matte filesize density\n1    PNG   450    303       sRGB  TRUE        0   72x72\n```\n\n\n:::\n:::\n\n## Writing an Image\n\nThe `image_write()` function saves an image to a file. You can specify the path and format of the output file.\n\n::: {.cell}\n\n```{.r .cell-code}\nimage_write(new_png, path = \"./images/new_png.png\", format = \"png\")\n```\n:::\n\n# 2. Basic Image Manipulations\n\nLet's read in another image to demonstrate some basic manipulations.\n\n::: {.cell}\n\n```{.r .cell-code}\nraw_logo <- image_read('./images/logo1.png')\nraw_logo\n```\n\n::: {.cell-output-display}\n![](3-image-processing_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n## Filling with Color\n\nThe `image_fill()` function can be used to fill areas of an image with a specified color. Here, we fill the white corners of the logo with green. The `fuzz` argument controls the tolerance of the color matching.\n\n::: {.cell}\n\n```{.r .cell-code}\nimg_filled <- raw_logo %>% \n    image_fill(\"green\", \"+1+1\", fuzz = 50, refcolor = \"white\") %>% \n    image_fill(\"green\", \"+140+1\", fuzz = 50, refcolor = \"white\") %>% \n    image_fill(\"green\", \"+1+99\", fuzz = 50, refcolor = \"white\") %>% \n    image_fill(\"green\", \"+140+99\", fuzz = 50, refcolor = \"white\")\n\nimg_filled\n```\n\n::: {.cell-output-display}\n![](3-image-processing_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n## Rotating an Image\n\nThe `image_rotate()` function rotates an image by a specified angle.\n\n::: {.cell}\n\n```{.r .cell-code}\nimg_filled %>% image_rotate(45)\n```\n\n::: {.cell-output-display}\n![](3-image-processing_files/figure-html/unnamed-chunk-8-1.png){width=816}\n:::\n:::\n\n## Adding a Border\n\nThe `image_border()` function adds a border to an image. You can specify the color and size of the border.\n\n::: {.cell}\n\n```{.r .cell-code}\nimg_filled %>% image_border(\"#CD5C5C\", \"20x20\")\n```\n\n::: {.cell-output-display}\n![](3-image-processing_files/figure-html/unnamed-chunk-9-1.png){width=692}\n:::\n:::\n\n## Making a Background Transparent\n\nThe `image_transparent()` function makes a specified color transparent. This is useful for creating images with transparent backgrounds.\n\n::: {.cell}\n\n```{.r .cell-code}\n# The fuzz argument (0-100) controls how similar colors need to be to be made transparent.\nb = img_filled %>% image_transparent(color = 'green', fuzz = 10)\nb\n```\n\n::: {.cell-output-display}\n![](3-image-processing_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n\n```{.r .cell-code}\nimage_write(b, path = \"images/b.png\", format = \"png\")\n```\n:::\n\n## Adjusting Opacity\n\nThe `image_colorize()` function can be used to adjust the opacity of an image.\n\n::: {.cell}\n\n```{.r .cell-code}\nb = img_filled %>% image_colorize(opacity = 80, color = 'white')\nb\n```\n\n::: {.cell-output-display}\n![](3-image-processing_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n## Adjusting Brightness\n\nThe `image_modulate()` function can be used to adjust the brightness, saturation, and hue of an image.\n\n::: {.cell}\n\n```{.r .cell-code}\nb = img_filled %>% image_modulate(brightness = 30)\nb\n```\n\n::: {.cell-output-display}\n![](3-image-processing_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n## Applying a Blur Effect\n\nThe `image_blur()` function applies a blur effect to an image. You can control the radius and sigma of the blur.\n\n::: {.cell}\n\n```{.r .cell-code}\nb = img_filled %>%  image_blur(10, 5)\nb\n```\n\n::: {.cell-output-display}\n![](3-image-processing_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n## Adding Text to an Image\n\nThe `image_annotate()` function adds text to an image. You can specify the text, font, size, color, and gravity (position).\n\n::: {.cell}\n\n```{.r .cell-code}\nb = img_filled %>% image_annotate(\"The quick brown fox\", font = 'Times', size = 20, gravity = \"southwest\", color = \"red\")\nb\n```\n\n::: {.cell-output-display}\n![](3-image-processing_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n## Resizing an Image\n\nThe `image_resize()` and `image_scale()` functions can be used to resize an image. `image_resize()` allows you to specify the new dimensions, while `image_scale()` scales the image by a factor.\n\n::: {.cell}\n\n```{.r .cell-code}\nb = img_filled %>% image_resize(\"200x200\")\nb\n```\n\n::: {.cell-output-display}\n![](3-image-processing_files/figure-html/unnamed-chunk-15-1.png){width=100}\n:::\n\n```{.r .cell-code}\nimage_info(b)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  format width height colorspace matte filesize density\n1    PNG   200    143       sRGB  TRUE        0   72x72\n```\n\n\n:::\n:::\n\n# 3. Advanced Image Manipulations\n\n## Creating a Black and White Logo\n\nBy combining several `magick` functions, we can perform more complex image manipulations. Here, we create a black and white version of the logo with a transparent background.\n\n::: {.cell}\n\n```{.r .cell-code}\nimg_filled2 <- raw_logo %>% \n    image_fill(\"transparent\", \"+1+1\", fuzz = 50, refcolor = \"white\") %>% \n    image_fill(\"transparent\", \"+140+1\", fuzz = 50, refcolor = \"white\") %>% \n    image_fill(\"transparent\", \"+1+99\", fuzz = 50, refcolor = \"white\") %>% \n    image_fill(\"transparent\", \"+140+99\", fuzz = 50, refcolor = \"white\")\n\nimg_filled2 %>% \n    image_channel(\"Opacity\") %>% \n    image_convert(matte = FALSE)\n```\n\n::: {.cell-output-display}\n![](3-image-processing_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n# 4. Integrating `magick` with `ggplot2`\n\nOne of the most powerful features of `magick` is its ability to be integrated with `ggplot2` to create more visually interesting plots.\n\n## Adding a Background Image to a Plot\n\nWe can use `annotation_custom()` and `rasterGrob()` to add an image as the background of a `ggplot2` plot.\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nlibrary(png)\nlibrary(grid)\n\nimg <- readPNG(\"./images/new_png.png\")\n\nbees <- data.frame(distance = c(0.5, 1, 1.5, 2, 2.5, 3),\n                  number = c(40, 34, 32, 22, 18, 10))\n\nggplot(data = bees, aes(x = distance, y = number)) +\n  annotation_custom(rasterGrob(img, \n                               width = unit(1, \"npc\"),\n                               height = unit(1, \"npc\")), \n                    -Inf, Inf, -Inf, Inf) +\n  geom_point() +\n  xlab(\"Distance (km)\") +\n  ylab(\"Number of Bees\") +\n  ylim(0, 45)\n```\n\n::: {.cell-output-display}\n![](3-image-processing_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n## Replacing Scatter Points with Images\n\nThe `ggimage` package provides `geom_image()`, which allows you to use images as points in a scatter plot.\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggimage)\n\nbees$image <- \"./images/bee.png\"\n\nggplot(data = bees, aes(x = distance, y = number)) +\n  annotation_custom(rasterGrob(img, \n                               width = unit(1, \"npc\"),\n                               height = unit(1, \"npc\")), \n                    -Inf, Inf, -Inf, Inf) +\n  geom_image(aes(image = image), size = 0.15) +\n  xlab(\"Distance (km)\") +\n  ylab(\"Number of Bees\") +\n  ylim(0, 45)\n```\n\n::: {.cell-output-display}\n![](3-image-processing_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n## Adding a Logo to a Plot\n\nThe `cowplot` package provides `ggdraw()` and `draw_image()` which make it easy to add a logo or other images to your `ggplot2` plots.\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(cowplot)\n\nimg2 = image_read(\"./images/logo1.png\")\n\np = ggplot(data = bees, aes(x = distance, y = number)) +\n  annotation_custom(rasterGrob(img, \n                               width = unit(1, \"npc\"),\n                               height = unit(1, \"npc\")), \n                    -Inf, Inf, -Inf, Inf) +\n  geom_image(aes(image = image), size = 0.15) +\n  xlab(\"Distance (km)\") +\n  ylab(\"Number of Bees\") +\n  ylim(0, 45)\n\nggdraw() + \n  draw_plot(p, x = 0, y = 0.15, width = 1, height = 0.85) + \n  draw_image(img2, x = 0.1, y = 0.1, width = 0.1, height = 0.1)\n```\n\n::: {.cell-output-display}\n![](3-image-processing_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n# 5. Conclusion and Further Resources\n\nThis document has provided a comprehensive introduction to the `magick` package in R. You have learned how to read, write, and manipulate images, as well as how to integrate them with `ggplot2` to create more engaging visualizations.\n\nFor more information and examples, please refer to the following resources:\n\n-   [The `magick` Package Vignette](httpshttps://cran.r-project.org/web/packages/magick/vignettes/intro.html)\n-   [Removing Image Backgrounds with `magick`](https://themockup.blog/posts/2021-01-28-removing-image-backgrounds-with-magick/)\n-   [Fun and Easy R Graphs with Images](https://buzzrbeeline.blog/2018/06/13/fun-and-easy-r-graphs-with-images/)\n\n\n\n",
    "supporting": [
      "3-image-processing_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}